데이터를 트랜젝션으로 변경
데이터에 맞춰서 Binning할 열 변경
```{R}
library(arules)

Health_original = read.csv("health.csv")
Health_data = Health_original

dim(Health_data)
head(Health_data, 3)

Health_data$Age = as.numeric(Health_data$Age)

# Convert numeric type into ordered factor type 
Health_data[["Age"]] <- ordered(cut(Health_data[["Age"]], c(18,28,38,48,58,68,78,88)),
                              labels = c("20s", "30s", "40s", "50s", "60s", "70s", "80s"))
Health_data[["Smoke"]] <- ordered(cut(Health_data[["Smoke"]], c(-1,0,5,10,15,20,50)),
                              labels = c("0", "1 ~ 5", "6 ~ 10", "11 ~ 15", "16 ~ 20", "21 ~"))

# Now, the data can be automatically recoded as a binary incidence matrix 
# by coercing the data set to transactions.
Health_transaction <- as(Health_data, "transactions")
Health_transaction

summary(Health_transaction)
inspect(Health_transaction)
```



트랜잭션 데이터 분석
lhs, rhs, 기준이 되는 conf, lift등 고려하여 변경 필요
```{R}
# Association Rule mining

# Source: http://r-statistics.co/Association-Mining-With-R.html
# Reference: https://www.datacamp.com/community/tutorials/market-basket-analysis-r
# Reference: http://r-statistics.co/Association-Mining-With-R.html
# Reference: https://blog.exploratory.io/introduction-to-association-rules-market-basket-analysis-in-r-7a0dd900a3e0

# Data: Health_transaction

# Example

library(arulesViz)
library(shinythemes)
library(pmml)

class(Health_transaction) 
# transaction data

inspect(head(Health_transaction, 3))
# show first 3 transactions

# convert txt file into transacton data 
# Read transation data
# tdata <- read.transactions("transactions_data.txt", sep="\t")
# Convert df to class transations
# tData <- as(myDataFrame, "transactions") # convert to 'transactions' class

# Some utility functions

size(head(Health_transaction, 3)) 
# number of items in each observation

LIST(head(Health_transaction, 3)) 
# convert 'transactions' 
# to a list, note the LIST in CAPS

# most frequent items

# The eclat() takes in a transactions object 
# and gives the most frequent items in the data 
# based the support you provide to the supp argument. 
# The maxlen defines the maximum number of items 
# in each itemset of frequent items.
frequentItems <- eclat (Health_transaction, 
                        parameter = list(supp = 0.021, 
                                         maxlen = 10)) 

inspect(head(frequentItems, 3))
# calculates support for frequent items

itemFrequencyPlot(Health_transaction, 
                  topN=10, 
                  type="absolute", 
                  main="Item Frequency") 
# plot frequent items

# How to get the product recommendation rules?

rules <- apriori (Health_transaction, 
                  parameter = list(supp = 0.005, 
                                   conf = 0.1)) 
# Min Support as 0.001, confidence as 0.8.

rules_conf <- sort (rules, by="confidence", decreasing=TRUE) 
# 'high-confidence' rules.

inspect(head(rules_conf)) 
# show the support, lift and confidence for all rules

rules_lift <- sort (rules, by="lift", decreasing=TRUE) 
# 'high-lift' rules.

inspect(head(rules_lift)) 
# show the support, lift and confidence for all rules

# How To Control The Number Of Rules in Output ?

rules <-
  apriori(Health_transaction,
          parameter = list (
            supp = 0.01, # min sup
            conf = 0.3,  # min cof
            maxlen = 6    # max num of elements
          )) 

inspect(head(rules, 3, by = "confidence"))

# maxlen = 6 limits the elements in a rule to 6

# 1 To get ??strong?? rules, increase the value of ??conf?? parameter.
# 2 To get ??longer?? rules, increase ??maxlen??.
# 3 To get 'important' rules, increase 'supp'.

# How To Remove Redundant Rules ?
# Sometimes it is desirable to remove the rules 
# that are subset of larger rules. 
# To do so, use the below code to filter the redundant rules.

length(rules)

rules

subsetRules <- which(rowSums(is.subset(rules, rules, proper = T)) > 1) 
# get subset rules in vector
length(subsetRules)  
#  
rules <- rules[-subsetRules] 
# remove subset rules. 
length(rules)

rules <- apriori(Health_transaction, 
                 parameter = list (supp = 0.001, 
                                   conf = 0.5, 
                                   maxlen = 3)) 
# maxlen = 3 limits the elements in a rule to 3

# How to Find Rules Related To Given Item/s ?
# To find what factors influenced purchase of product X
```

```{R}
rules <- apriori (data=Health_transaction, 
                  parameter=list (supp=0.001,
                                  conf = 0.08,
                                  maxlen = 4), 
                  appearance = list (default="lhs",
                                     rhs="Drink=high_risk"), 
                  control = list (verbose=F)) 
# get rules that lead to buying 'whole milk'

rules_conf <- sort (rules, by="confidence", decreasing=TRUE) 

write(rules, file = "data2.csv", sep = ",", col.names = NA)
# 'high-confidence' rules.
inspect(head(rules_conf))

inspect(head(rules, n = 5, by="confidence"))

# To find out what products were purchased after/along with product X

rules <- apriori (data=Health_transaction, 
                  parameter=list (supp=0.001,
                                  conf = 0.15,
                                  minlen=2), 
                  appearance = list(default="rhs",
                                    lhs="Drink=high_risk"), 
                  control = list (verbose=F)) 
# those who bought 'milk' also bought..

rules_conf <- sort (rules, by="confidence", decreasing=TRUE) 
# 'high-confidence' rules.

inspect(head(rules_conf))

write(rules, file = "data.csv", sep = ",", col.names = NA)
write.PMML(rules, file = "data.xml")

# Excercise
# example itemset 
basket1 <- c("a", "b",  "c")
basket2 <- c("a", "b")
basket3 <- c("c")
items <- as(list(basket1, basket2, basket3), "itemMatrix")

inspect(items)
is.subset(items)

items[1:2] -> items1
is.subset(items, items1)

rules <- apriori(items)
inspect(rules)
is.subset(rules)
is.subset(rules, proper = T)

subsetRules <- which(rowSums(is.subset(rules, rules, proper = T)) > 1) 
# get subset rules in vector
subsetRules
length(subsetRules)  

rules1 <- rules[-subsetRules]
inspect(rules1)
```


트리 ruleSet분석 
연관분석 결과값에 맞추어서 rpart목표변수 설정 필요
```{R}
library(rpart)
library(rattle)
library(caret)
library(rpart.plot)

# trControl = trainControl(method = 'repeatedcv', 
#                          number = 5, 
#                          repeats = 2)
# 
# tree = train(Drink~.,
#              data = Health_original,
#              method = "rpart",
#              trControl = trControl)
# 
# print(tree)
# print(tree$finalModel)
# fancyRpartPlot(tree$finalModel)

tree = rpart(Drink~., Health_original, method = "class", parms = list(split = "gini"),
      control = rpart.control(cp = -1, minsplit = 100, maxdepth = 3))

fancyRpartPlot(tree)
rpart.rules(tree)
```


각 열별 종속/독립성 체크


1)수치형 변수들끼리의 상관계수 검증(cor 활용)

```{R}
cor(Health_original$Age,Health_original$Smoke)

```

2) 명목형 변수끼리의 독립성 검증(chisq.test 활용)
```{R}
print(chisq.test(Health_original$High_blood_pressure,Health_original$Drink)) 
print(chisq.test(Health_original$High_blood_pressure,Health_original$Walking))   
print(chisq.test(Health_original$High_blood_pressure,Health_original$Exercise))   
print(chisq.test(Health_original$Drink,Health_original$Walking))           
print(chisq.test(Health_original$Drink,Health_original$Exercise))           
print(chisq.test(Health_original$Walking,Health_original$Exercise))       
```

3) 명목형 - 수치형 변수끼리의 독립성 검증(aov 활용)

```{R}

summary(aov(Age~High_blood_pressure,data=Health_original))
summary(aov(Age~Drink,data=Health_original))      
summary(aov(Age~Walking,data=Health_original))       
summary(aov(Age~Exercise,data=Health_original))    

summary(aov(Smoke~High_blood_pressure,data=Health_original))  
summary(aov(Smoke~Drink,data=Health_original))     
summary(aov(Smoke~Walking,data=Health_original))   
summary(aov(Smoke~Exercise,data=Health_original))    

```